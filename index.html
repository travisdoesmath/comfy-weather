<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="https://kit.fontawesome.com/56516660c8.js" crossorigin="anonymous"></script>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<style type="text/css">

/* On mouse hover, lighten state color */
path:hover {
	fill-opacity: .7;
}

/* div {
    border: 1px solid black;
} */

/* Style for Custom Tooltip */
div.tooltip {   
 	position: absolute;           
	text-align: center;
	padding: 2px;             
	font: 12px sans-serif;        
	background: white;   
	border: 0px;      
	border-radius: 8px;           
	pointer-events: none;         
}
        
/* Legend Font Style */
body {
	font: 11px sans-serif;
}
        
/* Legend Position Style */
.legend {
	position:absolute;
	left:800px;
	top:350px;
}

</style>
</head>
<body>
    <div id="body">
    </div>
<script type="text/javascript">

/*  This visualization was made possible by modifying code provided by:

Scott Murray, Choropleth example from "Interactive Data Visualization for the Web" 
https://github.com/alignedleft/d3-book/blob/master/chapter_12/05_choropleth.html   
		
Malcolm Maclean, tooltips example tutorial
http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html

Mike Bostock, Pie Chart Legend
http://bl.ocks.org/mbostock/3888852  */


var pageState = {
    'tempRange':[25,85],
    'incomeRange':[800,1200],
    'precipValue':[0,50]
}
		
//Width and height of map
var width = 960;
var height = 500;

// D3 Projection
var projection = d3.geoAlbersUsa()
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1000]);          // scale things down so see entire US
        
// Define path generator
var path = d3.geoPath()               // path generator that will convert GeoJSON to SVG paths
		  	 .projection(projection);  // tell path generator to use albersUsa projection

		
// Define linear scale for output
var color = d3.scaleLinear()
			  .range(["rgb(213,222,217)","rgb(69,173,168)","rgb(84,36,55)","rgb(217,91,67)"]);

var tempSlider = d3
    .sliderHorizontal()
    .tickFormat(x => x + "°")
    .min(-30)
    .max(120)
    .step(1)
    .width(450)
    .default(pageState.tempRange)
    .fill('#2196f3')
    .on('onchange', val => {
        pageState.tempRange = val
        drawStations();
    })

var incomeSlider = d3
    .sliderHorizontal()
    .tickFormat(d3.format('$'))
    .ticks(5)
    .min(0)
    .max(3500)
    .step(100)
    .width(450)
    .default(pageState.incomeRange)
    .fill('#2196f3')
    .on('onchange', val => {
        pageState.incomeRange = val
        drawStations();
    })

var precipSlider = d3
    .sliderHorizontal()
    .tickFormat(x => x + '"')
    .ticks(5)
    .min(0)
    .max(100)
    .step(1)
    .width(450)
    .default(pageState.precipValue)
    .fill('#2196f3')
    .on('onchange', val => {
        pageState.precipValue = val
        drawStations();
    })

var tempSliderDiv = d3.select("#body")
    .append("div")
    .classed("row", true)
    .classed("justify-content-center", true)
    .classed("align-items-center", true)
    .append("div")
    .classed("col-xs-12 col-lg-6", true)


tempSliderDiv.append("i")
    .attr("class", "fas fa-thermometer-half fa-fw fa-4x")
    .attr("title", "temperature normals")
    .style("color","#BBB")
    .style("width","10%")

tempSliderDiv
    .append("svg")
    // .attr("width", 500)
    // .attr("height", 100)
    .style("width","90%")
    .attr("viewBox", `0 0 500 60`)
    .append("g")
    .attr("transform","translate(20,20)")
    .call(tempSlider)

var incomeSliderDiv = d3.select("#body")
    .append("div")
    .classed("row", true)
    .classed("justify-content-center", true)
    .classed("align-items-center", true)
    .append("div")
    .classed("col-xs-12 col-lg-6", true)

incomeSliderDiv.append("i")
    .attr("class", "fas fa-money-bill-wave fa-fw fa-4x")
    .attr("title", "average weekly income")
    .style("color","#BBB")
    .style("width","10%")

incomeSliderDiv.append("svg")
    // .attr("width", 500)
    // .attr("height", 100)
    .style("width","90%")
    .attr("viewBox", `0 0 500 60`)
    .append("g")
    .attr("transform","translate(20,20)")
    .call(incomeSlider)

var precipSliderDiv = d3.select("#body")
    .append("div")
    .classed("row", true)
    .classed("justify-content-center", true)
    .classed("align-items-center", true)
    .append("div")
    .classed("col-xs-12 col-lg-6", true)

precipSliderDiv.append("i")
    .attr("class", "fas fa-cloud-showers-heavy fa-fw fa-4x")
    .attr("title", "annual rainfall")
    .style("color","#BBB")
    .style("width","10%")

precipSliderDiv.append("svg")
    // .attr("width", 500)
    // .attr("height", 100)
    .style("width","90%")
    .attr("viewBox", `0 0 500 60`)
    .append("g")
    .attr("transform","translate(20,20)")
    .call(precipSlider)

    const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on('zoom', zoomed);

//Create SVG element and append map to the SVG
var svg = d3.select("#body")
            .append("div").classed("row", true).classed("justify-content-center", true)
			.append("svg")
			// .attr("width", width)
			// .attr("height", height);
            .attr("viewBox", `0 0 ${width} ${height}`)
            .style('width', `${width}px`)

var g = svg.append("g");

var mapLayer = g.append('g');
var dataLayer = g.append('g');

svg.call(zoom)

// Append Div for tooltip to SVG
var div = d3.select("body")
		    .append("div")   
    		.attr("class", "tooltip")
            .style("width", "100px")               
    		.style("opacity", 0);


var files = [{"func":d3.json,"filename":"us-states.json"},
             {"func":d3.csv,"filename":"data.csv"},]
    promises = [];

files.forEach(function(file) {
    promises.push(file.func(file.filename))
})

var globalStations;

function drawStations() {

    comfyStations = stations
        .filter(x => x.min_temp > pageState.tempRange[0])
        .filter(x => x.max_temp < pageState.tempRange[1])
        .filter(x => x.AVG_WEEKLY_WAGE > pageState.incomeRange[0])
        .filter(x => x.AVG_WEEKLY_WAGE < pageState.incomeRange[1])
        .filter(x => x.annual_precipitation > pageState.precipValue[0])
        .filter(x => x.annual_precipitation < pageState.precipValue[1])

    stations_circles = dataLayer
        .selectAll("circle")
        .data(comfyStations, x => x.Name)

    stations_circles.enter()
        .append("circle")
        .attr("cx", function(d) {
            return projection([d.Longitude, d.Latitude])[0];
        })
        .attr("cy", function(d) {
            return projection([d.Longitude, d.Latitude])[1];
        })
        .attr("r", function(d) {
            // return Math.sqrt(d.years) * 4;
            return 1.5;
        })
        .classed("zoom",true)
        .style("fill", "rgb(217,91,67)")	
        .style("opacity", 0.85)	
        .on("mouseover", function(d) {      
            div.transition()        
            .duration(200)      
            .style("opacity", .9);      
            div.html(d.Name + "<br>" + d3.format('.1f')(d.min_temp) + "° to " + d3.format('.1f')(d.max_temp) + "°")
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px");    
        })   
        .on("mouseout", function(d) {       
            div.transition()        
            .duration(500)      
            .style("opacity", 0);   
        })

    stations_circles
        .exit()
        .remove()
}

function zoomed() {
    mapLayer
    .selectAll('.zoom') // To prevent stroke width from scaling
    .attr('transform', d3.event.transform);

    dataLayer.attr('transform', d3.event.transform);
}


Promise.all(promises).then(function(values) {
    console.log(values);
    states = values[0];
    stations = values[1];

    globalStations = values[1];

    // Bind the data to the SVG and create one path per GeoJSON feature
    mapLayer.selectAll("path")
        .data(states.features)
        .enter()
        .append("path")
        .classed("zoom",true)
        .attr("d", path)
        .style("stroke", "#fff")
        .style("stroke-width", "1")
        .style("fill", function(d) {

        // Get data value
        var value = d.properties.visited;

        if (value) {
        //If value exists…
        return color(value);
        } else {
        //If value is undefined…
        return "rgb(213,222,217)";
        }
    });

    drawStations() // convert to values from range element
})

</script>
</body>
</html>