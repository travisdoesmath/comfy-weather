<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="https://kit.fontawesome.com/56516660c8.js" crossorigin="anonymous"></script>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<style type="text/css">

/* On mouse hover, lighten state color */
path:hover {
	fill-opacity: .7;
}

/* div {
    border: 1px solid black;
} */

/* Style for Custom Tooltip */
div.tooltip {   
 	position: absolute;           
	text-align: center;
	padding: 2px;             
	font: 12px sans-serif;        
	background: white;   
	border: 0px;      
	border-radius: 8px;           
	pointer-events: none;         
}
        
/* Legend Font Style */
body {
	font: 11px sans-serif;
}
        
/* Legend Position Style */
.legend {
	position:absolute;
	left:800px;
	top:350px;
}

</style>
</head>
<body>
    <div id="body">
    </div>
<script type="text/javascript">

var pageState = {
    'tempRange':[20,90],
    'incomeRange':[500,1500],
    'precipRange':[0,60],
    'daysLt32':[0,280],
    'daysGt80':[0,365],
    'sunRange':[12000,21000]
}
		
//Width and height of map
var width = 960;
var height = 600;

// D3 Projection
var projection = d3.geoAlbersUsa()
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1250]);          // scale things down so see entire US
        
// Define path generator
var path = d3.geoPath()               // path generator that will convert GeoJSON to SVG paths
		  	 .projection(projection);  // tell path generator to use albersUsa projection

		
// Define linear scale for output
var color = d3.scaleLinear()
			  .range(["rgb(213,222,217)","rgb(69,173,168)","rgb(84,36,55)","rgb(217,91,67)"]);

function createSlider(options) {
    var Slider = d3
        .sliderHorizontal()
        .tickFormat(options.tickFormat)
        .min(options.min)
        .max(options.max)
        .step(options.step)
        .width(450)
        .default(options.default)
        .fill('#2196f3')
        .on('onchange', options.onchange)    
        
    var sliderDiv = d3.select("#body")
        .append("div")
        .classed("row", true)
        .classed("justify-content-center", true)
        .classed("align-items-center", true)
        .append("div")
        .classed("col-xs-12 col-lg-6", true)


    sliderDiv.append("i")
        .attr("class", `fas ${options.icon} fa-fw fa-4x`)
        .attr("title", options.title)
        .style("color","#BBB")
        .style("width","10%")

    sliderDiv
        .append("svg")
        // .attr("width", 500)
        // .attr("height", 100)
        .style("width","90%")
        .attr("viewBox", `0 0 500 60`)
        .append("g")
        .attr("transform","translate(20,20)")
        .call(Slider)
}

// temperature slider
// createSlider({
//     min:-30,
//     max:120,
//     step:1,
//     tickFormat:x => x + "°",
//     default:pageState.tempRange,
//     onchange:val => {
//             pageState.tempRange = val
//             drawStations();
//         },
//     icon:'fa-thermometer-half',
//     title:'temperature normals'
// })

// days less than 32 slider
createSlider({
    min:0,
    max:280,
    step:1,
    tickFormat:x => x,
    default:pageState.daysLt32,
    onchange:val => {
            pageState.daysLt32 = val
            drawStations();
        },
    icon:'fa-temperature-low',
    title:'days less than 32°'
})

// days greater than 80 slider
createSlider({
    min:0,
    max:365,
    step:1,
    tickFormat:x => x,
    default:pageState.daysGt80,
    onchange:val => {
            pageState.daysGt80 = val
            drawStations();
        },
    icon:'fa-temperature-high',
    title:'days greater than 80°'
})

// income slider
createSlider({
    min:0,
    max:3500,
    step:100,
    tickFormat:d3.format('$'),
    default:pageState.incomeRange,
    onchange:val => {
            pageState.incomeRange = val
            drawStations();
        },
    icon:'fa-money-bill-wave',
    title:'average weekly income'

})

// precip slider
createSlider({
    min:0,
    max:100,
    step:1,
    tickFormat:x => x + '"',
    default:pageState.precipRange,
    onchange:val => {
            pageState.precipRange = val
            drawStations();
        },
    icon:'fa-cloud-showers-heavy',
    title:'annual rainfall'

})


// sun slider
createSlider({
    min:12000,
    max:21000,
    step:100,
    tickFormat:x => d3.format('.0f')(x/1000) + 'k',
    default:pageState.sunRange,
    onchange:val => {
            pageState.sunRange = val
            drawStations();
        },
    icon:'fa-sun',
    title:'average daily sunlight (in KJ/m²)'

})



const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on('zoom', zoomed);

//Create SVG element and append map to the SVG
var svg = d3.select("#body")
            .append("div").classed("row", true).classed("justify-content-center", true)
            .append("div").classed("col-xs-12",true).classed("col-lg-6",true)
			.append("svg")
			// .attr("width", width)
			// .attr("height", height);
            .attr("viewBox", `0 0 ${width} ${height}`)
            .style('width', `100%`)

var g = svg.append("g");

var mapLayer = g.append('g');
var dataLayer = g.append('g');

svg.call(zoom)

// Append Div for tooltip to SVG
var div = d3.select("body")
		    .append("div")   
    		.attr("class", "tooltip")
            .style("width", "100px")               
    		.style("opacity", 0);


var files = [{"func":d3.json,"filename":"us-states.json"},
             {"func":d3.csv,"filename":"data.csv"},]
    promises = [];

files.forEach(function(file) {
    promises.push(file.func(file.filename))
})

var globalStations;

function drawStations() {

    comfyStations = stations
        .filter(x => projection([+x.Longitude, +x.Latitude]) != null)
        //.filter(x => +x.TMIN > pageState.tempRange[0])
        //.filter(x => +x.TMAX < pageState.tempRange[1])
        .filter(x => +x.DAYS_LT_32 > pageState.daysLt32[0])
        .filter(x => +x.DAYS_LT_32 < pageState.daysLt32[1])
        .filter(x => +x.DAYS_GT_80 > pageState.daysGt80[0])
        .filter(x => +x.DAYS_GT_80 < pageState.daysGt80[1])
        .filter(x => +x.ANN_PRECIP < pageState.precipRange[1])
        .filter(x => +x.AVG_WEEKLY_WAGE > pageState.incomeRange[0])
        .filter(x => +x.AVG_WEEKLY_WAGE < pageState.incomeRange[1])
        .filter(x => +x.ANN_PRECIP > pageState.precipRange[0])
        .filter(x => +x.ANN_PRECIP < pageState.precipRange[1])
        .filter(x => +x.AVG_DLY_SUN > pageState.sunRange[0])
        .filter(x => +x.AVG_DLY_SUN < pageState.sunRange[1])
        

    stations_circles = dataLayer
        .selectAll("circle")
        .data(comfyStations, x => x.COUNTY_NAME)

    stations_circles.enter()
        .append("circle")
        .attr("cx", function(d) {
            if (projection([+d.Longitude, +d.Latitude])) {
                return projection([+d.Longitude, +d.Latitude])[0];
            }
            else {
                console.log(d);
            }
        })
        .attr("cy", function(d) {
            return projection([+d.Longitude, +d.Latitude])[1];
        })
        .attr("r", function(d) {
            // return Math.sqrt(d.years) * 4;
            return 1.5;
        })
        .classed("zoom",true)
        .style("fill", "rgb(217,91,67)")	
        .style("opacity", 0.85)	
        .on("mouseover", function(d) {      
            div.transition()        
            .duration(200)      
            .style("opacity", .9);      
            // div.html(d.COUNTY_NAME + "<br>" + d3.format('.1f')(d.min_temp) + "° to " + d3.format('.1f')(d.max_temp) + "°" + "<br>")
            div.html(`${d.COUNTY_NAME}<br>${d3.format('.1f')(d.TMIN)}° to ${d3.format('.1f')(d.TMAX)}°<br>${d3.format('.1f')(d.DAYS_LT_32)} days under 32°<br>${d3.format('.1f')(d.DAYS_GT_80)} days over 80°<br>${d.ANN_PRECIP}\"<br>${d3.format('$')(d.AVG_WEEKLY_WAGE)}`)
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px");    
        })   
        .on("mouseout", function(d) {       
            div.transition()        
            .duration(500)      
            .style("opacity", 0);   
        })

    stations_circles
        .exit()
        .remove()
}

function zoomed() {
    mapLayer
    .selectAll('.zoom') // To prevent stroke width from scaling
    .attr('transform', d3.event.transform);

    dataLayer.attr('transform', d3.event.transform);
}


Promise.all(promises).then(function(values) {
    console.log(values);
    states = values[0];
    stations = values[1];

    globalStations = values[1];

    // Bind the data to the SVG and create one path per GeoJSON feature
    mapLayer.selectAll("path")
        .data(states.features)
        .enter()
        .append("path")
        .classed("zoom",true)
        .attr("d", path)
        .style("stroke", "#fff")
        .style("stroke-width", "1")
        .style("fill", function(d) {

        // Get data value
        var value = d.properties.visited;

        if (value) {
        //If value exists…
        return color(value);
        } else {
        //If value is undefined…
        return "rgb(213,222,217)";
        }
    });

    drawStations() // convert to values from range element
})

</script>
</body>
</html>